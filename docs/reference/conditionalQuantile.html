<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Conditional quantile estimates for model evaluation — conditionalQuantile • openair</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Conditional quantile estimates for model evaluation — conditionalQuantile" />
<meta property="og:description" content="Function to calculate conditional quantiles with flexible conditioning. The
function is for use in model evaluation and more generally to help better
understand forecast predictions and how well they agree with observations." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">openair</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.8-6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/davidcarslaw/openair">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Conditional quantile estimates for model evaluation</h1>
    <small class="dont-index">Source: <a href='https://github.com/davidcarslaw/openair/blob/master/R/conditionalQuantile.R'><code>R/conditionalQuantile.R</code></a></small>
    <div class="hidden name"><code>conditionalQuantile.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Function to calculate conditional quantiles with flexible conditioning. The
function is for use in model evaluation and more generally to help better
understand forecast predictions and how well they agree with observations.</p>
    </div>

    <pre class="usage"><span class='fu'>conditionalQuantile</span><span class='op'>(</span>
  <span class='va'>mydata</span>,
  obs <span class='op'>=</span> <span class='st'>"obs"</span>,
  mod <span class='op'>=</span> <span class='st'>"mod"</span>,
  type <span class='op'>=</span> <span class='st'>"default"</span>,
  bins <span class='op'>=</span> <span class='fl'>31</span>,
  min.bin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='fl'>20</span><span class='op'>)</span>,
  xlab <span class='op'>=</span> <span class='st'>"predicted value"</span>,
  ylab <span class='op'>=</span> <span class='st'>"observed value"</span>,
  col <span class='op'>=</span> <span class='fu'>brewer.pal</span><span class='op'>(</span><span class='fl'>5</span>, <span class='st'>"YlOrRd"</span><span class='op'>)</span>,
  key.columns <span class='op'>=</span> <span class='fl'>2</span>,
  key.position <span class='op'>=</span> <span class='st'>"bottom"</span>,
  auto.text <span class='op'>=</span> <span class='cn'>TRUE</span>,
  <span class='va'>...</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>mydata</th>
      <td><p>A data frame containing the field <code>obs</code> and <code>mod</code>
representing observed and modelled values.</p></td>
    </tr>
    <tr>
      <th>obs</th>
      <td><p>The name of the observations in <code>mydata</code>.</p></td>
    </tr>
    <tr>
      <th>mod</th>
      <td><p>The name of the predictions (modelled values) in <code>mydata</code>.</p></td>
    </tr>
    <tr>
      <th>type</th>
      <td><p><code>type</code> determines how the data are split
i.e. conditioned, and then plotted. The default is will produce a
single plot using the entire data. Type can be one of the built-in
types as detailed in <code>cutData</code> e.g. &#8220;season&#8221;,
&#8220;year&#8221;, &#8220;weekday&#8221; and so on. For example, <code>type
= "season"</code> will produce four plots --- one for each season.</p>
<p>It is also possible to choose <code>type</code> as another variable in the data
  frame. If that variable is numeric, then the data will be split into four
  quantiles (if possible) and labelled accordingly. If type is an existing
  character or factor variable, then those categories/levels will be used
  directly. This offers great flexibility for understanding the variation
  of different variables and how they depend on one another.</p>
<p>Type can be up length two e.g. <code>type = c("season", "weekday")</code> will
  produce a 2x2 plot split by season and day of the week. Note, when two
  types are provided the first forms the columns and the second the rows.</p></td>
    </tr>
    <tr>
      <th>bins</th>
      <td><p>Number of bins to be used in calculating the different quantile
levels.</p></td>
    </tr>
    <tr>
      <th>min.bin</th>
      <td><p>The minimum number of points required for the estimates of
the 25/75th and 10/90th percentiles.</p></td>
    </tr>
    <tr>
      <th>xlab</th>
      <td><p>label for the x-axis, by default &#8220;predicted value&#8221;.</p></td>
    </tr>
    <tr>
      <th>ylab</th>
      <td><p>label for the y-axis, by default &#8220;observed value&#8221;.</p></td>
    </tr>
    <tr>
      <th>col</th>
      <td><p>Colours to be used for plotting the uncertainty bands and median
line. Must be of length 5 or more.</p></td>
    </tr>
    <tr>
      <th>key.columns</th>
      <td><p>Number of columns to be used in the key.</p></td>
    </tr>
    <tr>
      <th>key.position</th>
      <td><p>Location of the key e.g. &#8220;top&#8221;,
&#8220;bottom&#8221;, &#8220;right&#8221;, &#8220;left&#8221;. See <code>lattice</code>
<code>xyplot</code> for more details.</p></td>
    </tr>
    <tr>
      <th>auto.text</th>
      <td><p>Either <code>TRUE</code> (default) or <code>FALSE</code>. If
<code>TRUE</code> titles and axis labels etc. will automatically try and format
pollutant names and units properly e.g.  by subscripting the `2' in NO2.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Other graphical parameters passed onto <code>cutData</code> and
<code>lattice:xyplot</code>. For example, <code>conditionalQuantile</code> passes the option
<code>hemisphere = "southern"</code> on to <code>cutData</code> to provide southern
(rather than default northern) hemisphere handling of <code>type = "season"</code>.
Similarly, common axis and title labelling options (such as <code>xlab</code>,
<code>ylab</code>, <code>main</code>) are passed to <code>xyplot</code> via <code>quickText</code>
to handle routine formatting.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Conditional quantiles are a very useful way of considering model
performance against observations for continuous measurements (Wilks, 2005).
The conditional quantile plot splits the data into evenly spaced bins. For
each predicted value bin e.g. from 0 to 10~ppb the <em>corresponding</em>
values of the observations are identified and the median, 25/75th and 10/90
percentile (quantile) calculated for that bin. The data are plotted to show
how these values vary across all bins. For a time series of observations
and predictions that agree precisely the median value of the predictions
will equal that for the observations for each bin.</p>
<p>The conditional quantile plot differs from the quantile-quantile plot (Q-Q
plot) that is often used to compare observations and predictions. A
Q-Q~plot separately considers the distributions of observations and
predictions, whereas the conditional quantile uses the corresponding
observations for a particular interval in the predictions. Take as an
example two time series, the first a series of real observations and the
second a lagged time series of the same observations representing the
predictions. These two time series will have identical (or very nearly
identical) distributions (e.g. same median, minimum and maximum). A Q-Q
plot would show a straight line showing perfect agreement, whereas the
conditional quantile will not. This is because in any interval of the
predictions the corresponding observations now have different values.</p>
<p>Plotting the data in this way shows how well predictions agree with
observations and can help reveal many useful characteristics of how well
model predictions agree with observations --- across the full distribution
of values. A single plot can therefore convey a considerable amount of
information concerning model performance. The <code>conditionalQuantile</code>
function in openair allows conditional quantiles to be considered in a
flexible way e.g. by considering how they vary by season.</p>
<p>The function requires a data frame consisting of a column of
observations and a column of predictions. The observations are
split up into <code>bins</code> according to values of the
predictions. The median prediction line together with the 25/75th
and 10/90th quantile values are plotted together with a line
showing a &#8220;perfect&#8221; model. Also shown is a histogram of
predicted values (shaded grey) and a histogram of observed values
(shown as a blue line).</p>
<p>Far more insight can be gained into model performance through conditioning
using <code>type</code>. For example, <code>type = "season"</code> will plot
conditional quantiles by each season. <code>type</code> can also be a factor or
character field e.g. representing different models used.</p>
<p>See Wilks (2005) for more details and the examples below.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Murphy, A. H., B.G. Brown and Y. Chen. (1989) Diagnostic
Verification of Temperature Forecasts, Weather and Forecasting,
Volume: 4, Issue: 4, Pages: 485-501.</p>
<p>Wilks, D. S., 2005. Statistical Methods in the
Atmospheric Sciences, Volume 91, Second Edition (International
Geophysics), 2nd Edition. Academic Press.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>See <code><a href='modStats.html'>modStats</a></code> for model evaluation statistics and the
  package <code>verification</code> for comprehensive functions for forecast
  verification.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>David Carslaw</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># load example data from package</span></span>
<span class='r-in'><span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>mydata</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'>## make some dummy prediction data based on 'nox'</span></span>
<span class='r-in'><span class='va'>mydata</span><span class='op'>$</span><span class='va'>mod</span> <span class='op'>&lt;-</span> <span class='va'>mydata</span><span class='op'>$</span><span class='va'>nox</span><span class='op'>*</span><span class='fl'>1.1</span> <span class='op'>+</span> <span class='va'>mydata</span><span class='op'>$</span><span class='va'>nox</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>mydata</span><span class='op'>)</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'># basic conditional quantile plot</span></span>
<span class='r-in'><span class='co'>## A "perfect" model is shown by the blue line</span></span>
<span class='r-in'><span class='co'>## predictions tend to be increasingly positively biased at high nox,</span></span>
<span class='r-in'><span class='co'>## shown by departure of median line from the blue one.</span></span>
<span class='r-in'><span class='co'>## The widening uncertainty bands with increasing NOx shows that</span></span>
<span class='r-in'><span class='co'>## hourly predictions are worse for higher NOx concentrations.</span></span>
<span class='r-in'><span class='co'>## Also, the red (median) line extends beyond the data (blue line),</span></span>
<span class='r-in'><span class='co'>## which shows in this case some predictions are much higher than</span></span>
<span class='r-in'><span class='co'>## the corresponding measurements. Note that the uncertainty bands</span></span>
<span class='r-in'><span class='co'>## do not extend as far as the median line because there is insufficient</span></span>
<span class='r-in'><span class='co'># to calculate them</span></span>
<span class='r-in'><span class='fu'>conditionalQuantile</span><span class='op'>(</span><span class='va'>mydata</span>, obs <span class='op'>=</span> <span class='st'>"nox"</span>, mod <span class='op'>=</span> <span class='st'>"mod"</span><span class='op'>)</span></span>
<span class='r-plt img'><img src='conditionalQuantile-1.png' alt='' width='700' height='433' /></span>
<span class='r-in'></span>
<span class='r-in'><span class='co'>## can split by season to show seasonal performance (not very</span></span>
<span class='r-in'><span class='co'>## enlightening in this case - try some real data and it will be!)</span></span>
<span class='r-in'></span>
<span class='r-in'><span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='fu'>conditionalQuantile</span><span class='op'>(</span><span class='va'>mydata</span>, obs <span class='op'>=</span> <span class='st'>"nox"</span>, mod <span class='op'>=</span> <span class='st'>"mod"</span>, type <span class='op'>=</span> <span class='st'>"season"</span><span class='op'>)</span></span>
<span class='r-in'></span>
<span class='r-in'></span>
<span class='r-in'></span>
</pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by David Carslaw, Karl Ropkins.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


